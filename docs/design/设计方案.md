# 设计方案 v2（MVP：共享开发环境、Workspace 目录隔离）

目标读者

- 希望用 Web UI 同时管理多个 AI/CLI 编程代理会话（Codex、Claude Code 等）的个人开发者
- MVP 交付方式偏“本地一键启动”（`docker compose up`），不追求强隔离与多租户

---

## 背景与核心目标

- 核心价值：让用户并行运行多个 agent 会话，提高等待期间的吞吐
- MVP 策略：优先保证“终端可用性 + Git 变更验收体验”，其余能力延后

核心目标

- 多 Workspace 并行：同一 Repo 可创建多个独立工作目录，支持并行开发/试验
- 多终端并行：每个 Workspace 内可开多个交互终端，会话可重连
- Git 验收友好：staged/unstaged 文件列表 + 单文件“全文内容 + 变更标注”
- 易交付：用户用 `docker compose` 启动服务；跨 macOS / Linux 可用；支持 `amd64` + `arm64`

非目标（MVP 明确不做）

- 强安全隔离（如 per-workspace 容器、资源配额、系统调用沙箱）
- 多用户/团队权限体系、登录注册、审计体系
- 公网暴露与端口预览治理（MVP 默认仅本机访问）

---

## 关键决策与取舍（v2 与 v1 的差异）

共享开发环境（单容器）

- 服务本身运行在一个长期存在的容器中，这个容器也充当“统一开发环境”
- 所有 Workspace 共享同一套工具链与登录态（容器内的 `dev` 用户 home）
- 取舍：
  - 优点：避免每个 Workspace 重复登录/重复安装；体验更接近“一个开发者一个长期 devbox”
  - 代价：失去 per-workspace 环境隔离与资源隔离；只能做进程级治理

Workspace 用“随机/唯一目录”隔离，而不是容器隔离

- 每个 Workspace 对应一个独立 worktree 目录（基于 Repo mirror + `git worktree`）
- 终端进程 `cwd` 固定到该目录，UI 与 API 层面强制“路径只允许落在该目录下”
- 取舍：
  - 优点：实现简单、性能好、无需 docker-in-docker
  - 代价：不能阻止进程主动 `cd ..`（因此不宣称强安全隔离）

持久化边界明确

- 承诺长期保留：
  - `/data`：SQLite、repo mirror、worktree（代码与元数据）
  - `/home/dev`：用户登录凭据、配置与用户自装工具链（nvm/pyenv/mise/uv 等装在 home 下的）
- 不承诺长期保留：
  - 通过 `apt` 安装到系统路径的包（容器重建会丢失）
  - 需要长期保留的系统级依赖，走“扩展镜像”流程（见后文）

---

## 用户体验（MVP 交互闭环）

Repo 维度

- 添加 Repo：
  - 输入 Git URL（HTTPS/SSH）
  - MVP 建议由用户在共享环境内自行配置 git/ssh（例如 `/home/dev/.ssh`、`~/.gitconfig`）
  - Credential（HTTPS PAT 管理）延后，不纳入 MVP 实现范围
- 同步 Repo：
  - 后端维护 bare mirror，定期/手动 fetch

Workspace 维度

- 创建 Workspace：
  - 选择 Repo + 目标分支（或提交/Tag，MVP 可先仅支持分支）
  - 系统基于 mirror 创建 worktree 目录
- 进入 Workspace：
  - 终端：可多开、可重连
  - Git 变更审查：三列对比视图（文件列表 + 旧代码 + 新代码）
- 删除 Workspace：
  - 关闭该 Workspace 下所有终端
  - 删除 worktree 目录与数据库记录

终端与 Agent

- 终端支持：
  - 交互输入、实时输出
  - resize（保证 `vim/top` 等可用）
  - 断线重连（保持会话或可选“新建会话”）
- Agent 快捷启动：
  - 用户可保存命令模板（例如 `codex`/`claude` 启动参数、环境变量）
  - 一键在某个 Workspace 的新终端中启动

---

## 核心抽象与模型（MVP）

对象与关系

- Repo
  - 远端仓库记录（URL、默认分支、mirror 路径、上次同步时间）
- Workspace
  - Repo 的一个独立工作目录（worktree），用于并行开发
  - 记录当前分支、路径、创建时间、删除时间等
- Terminal
  - 一个交互式 PTY 会话，绑定到某个 Workspace
- Credential（可选）
  - HTTPS PAT，按 host 复用
  - 延后，不纳入 MVP 实现范围

概念 ER（简化）

```
Repo 1..n Workspace 1..n Terminal
Credential 1..n Repo（按 host 复用，也可 Repo 直接引用 credentialId，延后实现）
```

Workspace 状态（v2）

- `ready`：worktree 目录存在，可创建终端
- `busy`：存在至少一个活跃终端（可由后端派生，不一定落库）
- `errored`：创建/切换分支等操作失败（记录错误原因）
- `deleted`：被删除（数据库中可软删或直接删除；MVP 建议硬删）

Terminal 状态（v2）

- `active`：PTY 进程运行中
- `closed`：进程退出或被关闭
- `errored`：PTY 创建失败、读写异常

---

## 数据落盘与目录结构

容器内约定

- 数据根目录：`/data`
- 默认用户：`dev`
- 用户 home：`/home/dev`
- Workspace 根目录：`/data/workspaces`
- Repo 镜像根目录：`/data/repos`

建议目录结构

- `/data/db.sqlite`
- `/data/repos/<repoId>/mirror.git`（bare mirror）
- `/data/workspaces/<workspaceId>/repo`（worktree 目录，包含工作区文件）
- `/data/tmp`（临时文件，可不持久化或在 `/data` 下定期清理）

Docker Compose 持久化

- `agent-workbench-data` → `/data`
- `agent-workbench-home` → `/home/dev`

重要说明（写入 README/启动提示）

- 升级服务版本通常意味着重建容器
- 只要不使用 `docker compose down -v`，上面的两个 volume 会保留，从而保住：
  - 代码与元数据（`/data`）
  - 登录凭据、配置、自装工具链（`/home/dev`）

---

## Git 与 Workspace 目录策略（mirror + worktree）

Repo mirror

- 初次添加 Repo：
  - 若 mirror 不存在：`git clone --mirror <url> <mirrorPath>`
  - 若存在：`git -C <mirrorPath> fetch --prune`
- 并发策略：
  - per-repo lock：任何 mirror fetch、worktree add/remove、引用更新都要加锁

创建 Workspace（worktree add）

- 选择 `<workspacePath>`：`/data/workspaces/<workspaceId>/repo`
- 创建方式：
  - `git -C <mirrorPath> worktree add <workspacePath> <branch>`
- 分支存在性：
  - 若分支不存在：返回可读错误（MVP 先不做自动 `-b` 创建）

切换分支（git switch）

- 在 `<workspacePath>` 内执行：`git switch <branch>`
- 注意：
  - Git worktree 默认不允许同一分支同时被多个 worktree checkout
  - 若用户切换到已被其他 Workspace 占用的分支，后端直接返回错误并提示：
    - 建议创建新 Workspace
    - 或切换到其他分支
    - 或（未来可选）使用 detached HEAD / `--force`（MVP 不开放）

Git 变更读取（为 UI 设计的最小集合）

- 文件列表（用于 Workspace 页面左侧两段列表）
  - staged：`git diff --cached --name-status -z`
  - unstaged（含未跟踪文件）：
    - tracked 变更：`git diff --name-status -z`
    - untracked：`git status --porcelain=v1 -z --untracked-files=all`（筛 `??`）
  - 可选：忽略空白字符变化（用于“格式化造成的大面积 diff”降噪）
    - `git diff -w ...` / `git diff --cached -w ...`
  - 返回字段补充（当前实现）
    - `oldPath`：重命名/复制（`R`/`C`）时携带
    - `indexSha`：尝试从 index 读取 blob sha（冲突态会优先取 stage 0）
    - `worktreeMtimeMs`、`worktreeSize`：仅在 `unstaged` 时尝试读取
      - 读取失败会忽略该字段
      - 当前实现使用 `fs.stat` 获取元信息，遇到软链时可能跟随到目标文件
- 单文件比较（用于 Workspace 页面右侧两列“旧/新”全文对齐）
  - staged：`HEAD` ↔ `INDEX`
  - unstaged：`INDEX` ↔ `WORKTREE`
  - 当前实现不返回 patch，仅返回两侧全文与可预览/降级信息
  - 展示目标：
    - “全文展示”：包含未变更行
    - “对齐块”：相同块对齐；不一致块按更高的一侧补空行占位
    - “同步滚动”：旧/新两列共享滚动容器（纵向与横向都天然同步）
  - untracked 文件：旧侧为空，新侧为工作区文件内容
  - rename 文件（若能识别）：旧侧用 oldPath 内容，新侧用 newPath 内容
- 大文件/二进制降级（MVP）
  - 超过阈值不展示（前端提示“文件过大，暂不支持预览，请用终端查看”）
  - 二进制/不可解码文件不展示（同上提示）

---

## 代码审查视图（Workspace 页面，MVP）

布局

- 三列视图，从左到右：
  - 文件列表列
  - 旧/新对比区（Monaco Diff Editor，side-by-side）
- 文件列表列分为上下两块，高度 1:1：
  - 上：Unstaged（含 untracked）
  - 下：Staged
  - 两块均可独立滚动
- 旧/新对比区宽度占剩余空间

交互

- 点击文件列表中的任意文件：
  - 右侧展示该文件的“旧/新”全文对比（只读）
  - 旧/新对齐、纵向/横向滚动同步：由 Monaco Diff Editor 提供
- 忽略空白字符变化开关
  - 文件列表层面：通过 `git diff -w` 降噪（更接近 Git 工具的结果）
  - Diff 展示层面：Monaco 仅支持 `ignoreTrimWhitespace`（无法做到完全等价 `-w`）
- 重命名文件（`R`/`C`）
  - 文件列表项携带 `oldPath`
  - 对比接口传 `oldPath`，后端以 `oldPath` 作为 base，`path` 作为 current

降级策略

- 大文件：标记为不可预览（提示用户用终端查看）
- 二进制/不可解码文件：标记为不可预览（提示用户用终端查看）
- 不安全路径/软链/非普通文件：标记为不可预览（提示用户用终端查看）

---

## Credential 与登录态共享策略

原则

- 共享的是“容器内 dev 用户”的登录态与配置
- 所有 Workspace 共享 `/home/dev`，因此共享：
  - `~/.ssh`（SSH key）
  - `~/.gitconfig`、`~/.config/*`（各类 CLI 登录）
  - 语言版本管理工具安装目录（例如 `~/.nvm`、`~/.pyenv`、`~/.local`）

HTTPS PAT（延后能力，不纳入 MVP）

- 适用：用户不想配置 SSH key，或企业环境要求 HTTPS
- 存储：
  - SQLite 中存 token（MVP 可明文，后续可加密/接系统 keychain）
  - API 永不回传明文 token（只回传 masked）
- 使用方式：
  - 通过 `GIT_ASKPASS` 注入 token，避免把 token 写入 remote URL

---

## 终端实现（PTY）

目标体验

- 真正交互式（可运行 `vim/top/git add -p` 等）
- 支持 resize
- 支持断线重连（重连后能看到当前 TUI 画面）
- 不做历史回放（MVP）
- 不做自动回收，只允许手动关闭

推荐实现

- 后端以 `tmux` 作为“可断线重连的终端会话载体”
  - 每个 `Terminal` 对应一个 `tmux session`
  - WebSocket 连接是临时 attach 客户端（断开不影响 session 内任务继续运行）
  - 默认不允许“多处同时操作”：若该终端已在其他位置连接，WebSocket 连接应拒绝（返回错误）
  - 支持“接管连接”：显式携带 `force=1` 才允许踢掉旧连接并接管
- 后端仍需使用 PTY 承载 attach 过程（Node 可选 `node-pty`）
- 通信使用 WebSocket（双向）
  - 客户端消息：`input`、`resize`
  - 服务端消息：`output`、`exit`、`error`、`status`

会话重连策略（MVP 建议）

- Terminal 的“本体”是 `tmux session`，不依赖 WebSocket 存活
- WebSocket 断开或用户关闭浏览器：
  - 仅 detach，`tmux session` 继续运行
  - 用户再次进入页面时重新 attach，即可看到当前 TUI 画面
- 后端重启不影响 `tmux session`（仍可再次连接）
- 终端手动关闭时删除会话（kill `tmux session` 并删除记录）

进程治理（最低限度）

- 不做自动回收
- Workspace 删除时强制关闭其下所有 Terminal（kill `tmux session`）

---

## API 草案（MVP，localhost only）

约定

- Base URL：`http://127.0.0.1:<port>/`
- JSON：`application/json; charset=utf-8`
- WebSocket：`/api/terminals/:terminalId/ws`
- MVP 不做鉴权，但默认只监听 `127.0.0.1`

在线文档（OpenAPI）

- 使用 `@fastify/swagger` + `@fastify/swagger-ui`
- 文档页面：`GET /api/docs`
- OpenAPI JSON：`GET /api/openapi.json`
- 生成方式：路由 `schema` 作为单一真源，避免手写两份文档

Health

- `GET /api/health`
  - `{ ok: true, name: "agent-workbench", version: "<string>" }`
  - `version` 说明（当前实现）
    - 优先读环境变量：`AWB_APP_VERSION`
    - 其次尝试从启动时工作目录或仓库内的 `apps/api/package.json` 探测
    - 若都不可用，回退为 `"0.0.0"`

Repos

- `POST /api/repos`
  - `{ url }`
  - 行为：先落库（列表可查），再异步同步 mirror；不允许重复添加
- `GET /api/repos`
- `GET /api/repos/:repoId`
- `POST /api/repos/:repoId/sync`
- `GET /api/repos/:repoId/branches`
  - 行为：读取 mirror 的 heads 分支，返回短名
- `DELETE /api/repos/:repoId`
  - 行为：若存在引用该 repo 的 workspace 则 `409`；否则删除 mirror 目录与记录

Workspaces

- `POST /api/workspaces`
  - `{ repoId, branch }`
  - 行为：必须先校验分支存在（仅 heads）；repo syncing 时拒绝创建
- `GET /api/workspaces`
- `GET /api/workspaces/:workspaceId`
- `POST /api/workspaces/:workspaceId/git/checkout`
  - `{ branch }`
  - 行为：必须先校验分支存在（仅 heads）；repo syncing 时拒绝切换
- `DELETE /api/workspaces/:workspaceId`

Changes（Git 审查）

- `GET /api/workspaces/:workspaceId/changes?mode=unstaged|staged`
- `GET /api/workspaces/:workspaceId/file-compare?mode=unstaged|staged&path=...&oldPath=...`
  - `oldPath` 可选，用于重命名/复制的 base 侧

Git（写操作）

- `POST /api/workspaces/:workspaceId/git/stage`
- `POST /api/workspaces/:workspaceId/git/unstage`
- `POST /api/workspaces/:workspaceId/git/commit`
- `POST /api/workspaces/:workspaceId/git/push`
- `POST /api/workspaces/:workspaceId/git/pull`

Terminals

- `POST /api/workspaces/:workspaceId/terminals`
  - `{ shell? }`（默认 `bash`，不存在则 `sh`）
  - 行为：创建 `tmux session`（cwd=workspace 目录）
- `GET /api/workspaces/:workspaceId/terminals`
  - 行为（当前实现）
    - 仅返回 `active` 状态的 terminals
    - 会对 `active` 记录做一次 `tmux has-session` 对账，不存在则标记为 `closed` 并不再返回
- `GET /api/terminals/:terminalId`
- `DELETE /api/terminals/:terminalId`
  - 行为：kill `tmux session` 并删除记录
- `GET /api/terminals/:terminalId/ws`（WebSocket 升级）
  - 行为：
    - 默认：若已有连接则拒绝；否则通过 PTY 执行 `tmux attach -t <session>` 并透传字节流
    - 接管：`?force=1` 时通过 PTY 执行 `tmux attach -d -t <session>` 踢掉旧连接并接管

---

## 后端工程结构（约定）

目标

- 按业务模块组织代码，便于逐步实现完整接口（Repo/Workspace/Terminal）
- HTTP 层保持薄，业务逻辑集中在 service，数据访问集中在 store
- 基础设施能力统一下沉到 `infra/`，避免散落的命令执行与路径拼接

目录结构建议（`apps/api/src`）

- `main.ts`
  - 进程入口：加载 env、初始化 `AWB_DATA_DIR`、open DB、createApp、listen
- `app/`
  - `createApp.ts`：创建 Fastify 实例、注册 swagger、挂载模块 routes、统一错误处理
  - `context.ts`：`AppContext`（db、dataDir 等）注入
- `config/`
  - `env.ts`：环境变量解析与校验
- `infra/`
  - `db/`：db 打开、schema/迁移
  - `git/`：git exec、mirror、refs、worktree
  - `tmux/`：tmux exec、session 管理（new/has/kill/attach）
  - `locks/`：per-repo lock
  - `fs/`：目录创建/删除、统一路径生成（repos/workspaces/terminals）
- `modules/`
  - `health/`：`health.service.ts`、`health.routes.ts`（schema 已迁移到 `packages/shared/src/contracts/health.ts`）
  - `repos/`：`repo.model.ts`、`repo.store.ts`、`repo.service.ts`、`repo.routes.ts`
  - `workspaces/`：`workspace.model.ts`、`workspace.store.ts`、`workspace.service.ts`、`workspace.routes.ts`
  - `terminals/`：`terminal.model.ts`、`terminal.store.ts`、`terminal.service.ts`、`terminal.ws.ts`、`terminal.routes.ts`
  - 约束：模块内严格分层，即使功能简单也保持一致结构
- `utils/`
  - id、时间、通用类型等无业务含义的工具

---

## 前后端共享契约（TypeBox）

目标

- 前后端共享同一份 API 契约（请求/响应 DTO），避免重复定义与漂移
- 后端校验、TypeScript 类型、OpenAPI 文档三者同源

约定

- 使用 TypeBox 定义 schema（JSON Schema），并由 schema 推导 TypeScript 类型
- 契约存放位置：`packages/shared/src/contracts/*`
  - 例如：`packages/shared/src/contracts/repos.ts`、`packages/shared/src/contracts/workspaces.ts`、`packages/shared/src/contracts/terminals.ts`
- 后端路由直接引用契约 schema 作为 `schema`：
  - Fastify 用它做请求校验
  - `@fastify/swagger` 用它生成 OpenAPI
- 前端依赖 `packages/shared` 导出的类型（由同一份 schema 推导）

## 前端体验与缓存策略（MVP）

页面结构

- 首页（工作台/启动页，桌面应用风格）：
  - 顶部标题区
  - 标题下紧接 Tabs：`Workspaces` / `Repos`
  - Tabs 下方剩余空间展示对应列表（MVP 不提供筛选）
- Workspaces Tab（列表页）：
  - 创建 Workspace、打开 Workspace、删除 Workspace
  - 打开 Workspace：新浏览器标签页打开 Workspace 页面
  - 去重策略（同浏览器内尽量复用）：使用命名窗口 `window.open(url, "workspace_<id>")` 复用已打开页
- Repos Tab（列表页）：
  - 添加 Repo、同步 Repo、删除 Repo（删除需确认；若存在 Workspace 引用则提示失败原因）
- Workspace 页面（独立标签页，核心）：
  - 由“代码审查区 + Terminal Tabs 区”两部分组成
  - 支持“上下/左右”两种布局切换（MVP 固定比例，Terminal 占 1/3 高度或宽度，不支持拖拽调节）
  - Terminal Tabs：
    - 当 Workspace 没有终端时默认收缩，仅展示 `+` 创建按钮
    - 创建终端后自动展开，并默认选中第一个 terminal tab
  - 代码审查区：MVP 先用文本占位，后续再接入 staged/unstaged 列表与 diff 视图（Monaco）

终端连接交互（WS force）

- 页面加载时：对该 Workspace 下所有终端尝试建立 WebSocket 连接（不带 `force`）
- 若连接被拒绝（终端已在其他位置连接）：
  - 该 tab 不自动连接
  - 展示“连接/接管连接”按钮与提示
  - 接管连接需二次确认，确认后使用 `?force=1` 建连（会踢掉旧连接）

缓存策略（前端优先）

- 文件内容与 diff 采用 LRU，只缓存：
  - 当前选中文件
  - 最近访问文件（小容量）
- 文件列表刷新只拉元数据
- 大文件降级时 UI 明确提示（截断/不可预览）

---

## 安全与稳定性（MVP 基线）

访问边界

- 默认只监听 `127.0.0.1`
- 静态资源同源托管（避免 CORS/证书问题）

路径与文件边界（必须做）

- 所有带 `path` 的 API：
  - 统一进行路径规范化
  - 拒绝空路径
  - 拒绝绝对路径
  - 拒绝包含 `..` 段（例如 `a/../b` 也会拒绝）
  - 拒绝以 `-` 或 `:` 开头（避免 git/pathspec 等歧义）
  - 拒绝包含 `\\0`、换行符等异常字符
  - 强制要求目标路径最终落在该 Workspace 根目录之下
- 对软链接逃逸：
  - 当前实现：
    - `file-compare` 的工作区侧读取会拒绝软链、非普通文件，并会做 `realpath` 二次边界校验
    - 触发时会返回 `previewable: false` 且 `reason: "unsafe_path"`（而不是无限兜底）

命令执行策略

- Git 操作尽量使用“固定参数 + 结构化输出”的专用接口
- 若必须提供通用 exec：
  - 限制工作目录为 workspace
  - 设置超时、并发上限、输出截断

稳定性

- 全局并发限制（终端数、同步任务数）
- per-repo lock
- 关键操作可取消（至少能中断长时间 fetch）

---

## 交付与部署（docker compose）

镜像与架构

- 发布多架构镜像：`linux/amd64`、`linux/arm64`
- 基础镜像建议：`node:<LTS>-bookworm-slim`
- 预装工具建议（最小集合）：
  - `bash`、`git`、`openssh-client`、`ca-certificates`、`curl`、`less`、`procps`、`iproute2`、`vim`（或 `nano`）

环境变量建议

- `AWB_DATA_DIR=/data`
- `AWB_HOST=127.0.0.1`
- `AWB_PORT=...`
- `AWB_FILE_MAX_BYTES=...`
  - 说明（当前实现）
    - 后端当前读取的变量统一为 `AWB_*` 前缀,避免与用户项目常见变量名冲突
    - 例如: `AWB_DATA_DIR`、`AWB_HOST`、`AWB_PORT`、`AWB_FILE_MAX_BYTES`、`AWB_SERVE_WEB`、`AWB_WEB_DIST_DIR`、`AWB_AUTH_TOKEN`、`AWB_AUTH_COOKIE_SECURE`、`AWB_CREDENTIAL_MASTER_KEY`、`AWB_APP_VERSION`

扩展镜像流程（当用户需要系统级依赖）

- 提供一个 `Dockerfile.extend` 模板：
  - `FROM <官方发布镜像:tag>`
  - `RUN apt-get update && apt-get install -y ...`
- 用户在本地 build 自己的镜像，然后在 compose 里替换 image

---

## 未来演进方向（不影响 MVP 的扩展点）

运行驱动抽象

- `driver=shared-container`（本方案，MVP 默认）
- `driver=docker-per-user`（未来多用户时更匹配的形态）
  - 每个用户拥有一个长期存在的“开发环境容器”，用户的登录态与工具链在该容器内持续保留
  - Workspace 仍以目录/worktree 方式隔离（同一用户容器内多个 Workspace）
  - 服务端负责把“用户会话 → 对应用户容器 → 对应 Workspace”路由清晰化

不计划支持（倾向永久放弃）

- `docker-per-workspace`：每个 Workspace 一个容器的形态对本产品价值不大，复杂度与权限面更高（尤其是跨 macOS/Linux 的交付与数据落盘），除非未来出现明确的强隔离诉求，否则不纳入路线图

功能演进

- 鉴权：
  - 本地访问 token
  - 后续再扩展到多用户/团队
- 端口预览：
  - 反代 + 鉴权 + 可见端口列表
- Job 系统：
  - 统一管理长任务（sync、create、pull 等），支持取消与进度
- 代码导航：
  - Tree-sitter/LSP 索引（按需）

---

## 接口列表（确定版，MVP）

说明

- `POST /api/repos`：先落库让列表可查，再异步同步 mirror；同步失败保留 Repo
- Repo 去重：相同 URL 不允许重复添加（返回 `409`）
- 分支校验：仅允许 heads 分支短名；Workspace 创建/切换分支必须先校验分支存在；Repo syncing 时拒绝 Workspace 操作
- Terminal：使用 `tmux session` 承载；不做历史回放；新连接踢掉旧连接；手动关闭才删除会话

基础

- `GET /api/health`：健康检查与版本信息

Repos

- `POST /api/repos`：创建 Repo 并异步同步 mirror
- `GET /api/repos`：Repo 列表
- `GET /api/repos/:repoId`：Repo 详情
- `POST /api/repos/:repoId/sync`：触发异步同步
- `GET /api/repos/:repoId/branches`：列出 heads 分支（短名）
- `DELETE /api/repos/:repoId`：删除 Repo（有 workspace 引用则 `409`），同时删除 mirror 目录

Workspaces

- `POST /api/workspaces`：创建 Workspace
- `GET /api/workspaces`：Workspace 列表
- `GET /api/workspaces/:workspaceId`：Workspace 详情
- `POST /api/workspaces/:workspaceId/git/checkout`：切分支
- `DELETE /api/workspaces/:workspaceId`：删除 Workspace

Git（写操作）

- `POST /api/workspaces/:workspaceId/git/stage`：暂存
- `POST /api/workspaces/:workspaceId/git/unstage`：取消暂存
- `POST /api/workspaces/:workspaceId/git/commit`：提交
- `POST /api/workspaces/:workspaceId/git/push`：推送到远端
- `POST /api/workspaces/:workspaceId/git/pull`：拉取（`--ff-only`）

Terminals

- `POST /api/workspaces/:workspaceId/terminals`：创建 Terminal（创建 `tmux session`）
- `GET /api/workspaces/:workspaceId/terminals`：列出活跃 Terminal（仅返回 `active`）
- `GET /api/terminals/:terminalId`：Terminal 状态
- `DELETE /api/terminals/:terminalId`：手动关闭 Terminal（kill `tmux session` 并删除记录）
- `GET /api/terminals/:terminalId/ws`：WebSocket attach（新连接踢掉旧连接）

Git 审查

- `GET /api/workspaces/:workspaceId/changes?mode=unstaged|staged`：变更文件列表
- `GET /api/workspaces/:workspaceId/file-compare?mode=unstaged|staged&path=...&oldPath=...`：单文件全文对比（可降级为不可预览）
