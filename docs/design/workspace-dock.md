# Workspace 页面 Dock 架构设计

## 背景

- 当前 `Workspace` 页面主要由“代码审查 + 终端”两块组成，通过分割线做上下/左右分屏
- 现状适合 MVP，但当工具增多（例如文件浏览/预览、搜索、任务列表等）时：
  - 页面布局难扩展（只能继续堆分屏逻辑）
  - Header 功能按钮与特定工具耦合（按钮需要依赖工具状态、并触发工具刷新）
  - 工具之间跳转/联动缺少统一机制（激活工具 + 传参）

## 目标

- Header 保持整体结构不变，并在右侧增加“可注册按钮区”
- Header 以下的 Body 占满屏幕
- Body 左右两侧各有工具栏（icon）
  - 左工具栏分为上下两段
  - 右工具栏为整体一段
- 工具栏与 Center 的映射关系固定
  - 左上视图：对应左工具栏上段
  - 右上视图：对应右工具栏
  - 下方视图：对应左工具栏下段
- Center 支持自适应占满
  - 左上/右上任一未显示（无工具或最小化），另一侧占满上方区域
  - 下方未显示时，上方占满整个 Center
- 分割线可拖拽调整占比
  - 左上与右上之间可拖拽调整宽度占比
  - 上方与下方之间可拖拽调整高度占比
- 工具通过注册方式接入页面
  - 工具注册提供视图组件与 icon 组件
  - 工具视图可以获取页面暴露的最小化方法，在组件内部实现最小化按钮
- 工具位置可由页面统一管理（入口在 icon 右键菜单）
- 预留工具间互相调用能力（激活工具 + 传参），避免未来大改

## 非目标（当前阶段不做）

- 复杂的 Header 自定义渲染（当前仅支持“按钮”注册；复杂组件后续再扩展）
- 工具隐藏时的资源降载协议（例如 onVisibilityChange）；如需再补
- Workspace 之间的切换与布局缓存（当前通过新页面打开 Workspace，不在同页切换）
- 跨区域移动时的组件实例保活（允许重建）

## 术语与区域定义

- `DockArea`
  - `leftTop`：左上
  - `leftBottom`：下方（左下）
  - `rightTop`：右上
- “激活且可见”
  - 一个区域同一时间最多一个“激活工具”
  - 工具“激活且未最小化”才视为“可见”
  - Header 的工具按钮仅随“激活且可见”的工具显示

## 默认工具与可用位置

- 代码审查（CodeReview）
  - 默认位置：`leftTop`
  - 可用位置：仅 `leftTop`（固定在左上）
- 终端（Terminal）
  - 默认位置：`leftBottom`
  - 可用位置：`leftBottom`、`leftTop`、`rightTop`

## 布局与比例

- 默认比例
  - 左上:右上 = 2:1
  - 上:下 = 2:1
- 分割线显示规则
  - 仅当两侧区域都“激活且可见”时才显示对应分割线
  - 只有一个区域可见时，该区域占满对应空间

## 工具注册模型（建议的最小集合）

- 工具定义（ToolDefinition）
  - `toolId`
  - `icon`：工具栏 icon 组件
  - `view`：工具视图组件
  - `defaultArea`
  - `allowedAreas`
  - `keepAlive`：区域内保活开关（默认 false）
  - `headerActions`：Header 按钮注册（可选）

## Header 按钮注册

- Header 右侧提供按钮容器
- 同时展示三个区域“激活且可见”的工具按钮
  - 渲染顺序固定：`leftTop` → `leftBottom` → `rightTop`
- 全局按钮与工具按钮并存
  - 全局按钮不随工具显隐变化
  - 工具按钮仅随该区域“激活且可见”的工具显示
- 当前约定
  - 切换分支（checkout）：全局按钮
  - 拉取（pull）、推送（push）：由代码审查工具注册，随代码审查“激活且可见”显示

## 工具交互规则

- 单击 icon（同一区域内切换）
  - 点击“非激活工具”：激活并显示该工具
  - 点击“已激活工具”：切换最小化（显示 ↔ 最小化）
- 右键 icon（工具移动入口）
  - 由页面统一提供“移动到…”菜单
  - 菜单选项来自 `allowedAreas`

## 工具移动规则（已达成一致的行为）

- 工具当前隐藏
  - 只移动 icon（工具所属区域变化），不改变任何区域的“当前显示工具”
- 工具当前显示
  - 目标区域没有显示的工具：移动并显示被移动工具
  - 目标区域有显示的工具：只移动 icon，不激活被移动工具
- “目标区域没有显示的工具”的定义
  - 目标区域当前不存在“激活且可见”的工具

## keepAlive 策略

- 区域内必须支持 keepAlive
  - 理由：部分复杂布局/组件状态不是简单 store 能覆盖
- 跨区域移动允许重建
  - 理由：跨区域保活实现复杂度高，当前阶段优先保证可用与可扩展
- 工具仍可用组合式 store 保持进程级状态（即使重建也能恢复部分状态）

## Host API（页面对工具暴露的能力）

- 最小化/激活
  - `minimizeTool(toolId)`
  - `toggleMinimize(toolId)`
  - `openTool(toolId)`：在“工具当前所在区域”激活并显示，不指定区域、不自动搬运
- 工具命令注册（用于替代直接 ref 调用子组件方法）
  - `registerToolCommands(toolId, commands)`：例如 `refresh()`
- 工具间事件（预留）
  - `emitToolEvent(targetToolId, event)`：Host 暂存事件，目标工具挂载后消费

## 关键决策与取舍

- `openTool` 不提供“指定区域”参数
  - 好处：实现简单、规则稳定
  - 代价：调用方无法强制把工具搬到自己附近；如需可走“移动工具”入口
- Header 暂时只支持“按钮”注册
  - 好处：约束清晰、样式一致
  - 代价：复杂交互（搜索框/下拉复杂面板）后续再扩展
- Header 同时展示三个区域的工具按钮（固定顺序）
  - 好处：按钮更贴近对应工具视图，减少“当前焦点工具”的额外概念
  - 代价：Header 空间可能被占满；后续可引入溢出收纳（更多按钮进 `...` 菜单）
- 工具隐藏时不做资源降载协议
  - 好处：当前实现成本低
  - 代价：隐藏但 keepAlive 的工具可能持续轮询/占用资源；需要时再扩展 onVisibilityChange

